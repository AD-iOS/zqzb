name: Cydia Repo Auto-Update

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'  # 每天UTC时间3:00自动运行

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev coreutils

      - name: Generate Packages
        run: |
          # 掃描 debs 目錄生成 Packages 文件
          dpkg-scanpackages -m debs > Packages 2>/dev/null || true
          gzip -c9 Packages > Packages.gz
          bzip2 -c9 Packages > Packages.bz2

      - name: Generate Release file
        run: |
          # 生成或更新 Release 文件
          cat > Release << EOF
          Origin: Your Repo Name
          Label: Your Repo Label
          Suite: stable
          Version: 1.0
          Codename: ios
          Architectures: iphoneos-arm
          Components: main
          Description: Your repository description
          MD5Sum:
          EOF

          # 添加文件校驗信息
          for file in Packages Packages.gz Packages.bz2; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file" | awk '{print $1}')
              md5=$(md5sum "$file" | cut -d' ' -f1)
              echo " $md5 $size $file" >> Release
            fi
          done

      - name: Validate generation
        run: |
          # 檢查必要文件是否生成
          [ -f Packages ] || { echo "Packages file missing"; exit 1; }
          [ -f Release ] || { echo "Release file missing"; exit 1; }

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Auto-update: $(date +'%Y-%m-%d %H:%M:%S')"
          git push